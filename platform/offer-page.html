<div class="row">
    <div class="start">
        <div id="offer" class="row">
        </div><br>
        <div class="form-group offer-page-control">
        </div><br>
        
        <div class="interested-message">
            <p>Are you interested in this offer? Get in touch with the author:</p>
    
            <div class="message-form">
                <div class="form-group">
                  <label for="subject">Subject:</label>
                  <input type="text" class="form-control span3" id="subject">
                </div>
                <div class="form-group">
                  <label for="comment">Message:</label>
                  <textarea class="form-control span6" rows="5" id="comment" placeholder="Your message..."></textarea>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-warning send-message">Send message</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        function ajaxGetCall(url, errorCallback, successCallback){
            $.ajax({
                url: url,
                async: false,
                type: 'get',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                },
                data: {},
                dataType: 'json',
                cache: false,
                error: errorCallback,
                success: successCallback
            });
        }
        
        var currentUser = JSON.parse(localStorage.getItem("currentUser"));
        var oKey = JSON.parse(localStorage.getItem("currentKey"))[0].operationKey;
        window.app.page("offer-page", function(){
            return function(params) {
                ajaxGetCall('https://api.backand.com/1/query/data/getReferOffer?parameters=%7B%22id%22:%22'+parseInt(params)+'%22%7D', function(error){alert(JSON.stringify(error))}, 
                function(data){
                    myRecord = data;
                    
                    if(myRecord[0].deletedAt){
                        window.location.replace('/404');
                    }
                    else{
                        $("#offer").append("<div class='span12'><p><i class='icon-time'></i>&nbsp;<span class='timeago'>"+$.timeago(myRecord[0].dateCreated)+"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author: "+myRecord[0].author+"</p><h1>"+myRecord[0].title+"</h1><p>"+myRecord[0].content+"</p><h4><b>Company: </b>"+myRecord[0].company+"</h4><h4><b>Location: </b>"+myRecord[0].city+", "+myRecord[0].country+"</h4></div>");
                    }
                });
                ajaxGetCall('https://api.backand.com/1/objects/action/ReferOffer/'+parseInt(params)+'?name=allowEdit&parameters=%7B%22operationKey%22:%22'+oKey+'%22%7D',
                function(error){alert(JSON.stringify(error))}, 
                function(data){
                    if(data){
                        $(".offer-page-control").html('<button type="button" class="btn btn-warning">Edit&nbsp;&nbsp;<i class="icon-edit"></i></button>&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-danger delete-offer">Delete&nbsp;&nbsp;<i class="icon-ban-circle"></i></button>');
                        $(".interested-message").hide();
                        $(".delete-offer").on("click", function(){
                            var date = new Date()
                            swal({
                              title: "Are you sure?",
                              type: "warning",
                              showCancelButton: true,
                              confirmButtonColor: "#DD6B55",
                              confirmButtonText: "Yes, delete it!",
                              cancelButtonText: "No, cancel!",
                              closeOnConfirm: false,
                              closeOnCancel: false,
                              allowOutsideClick: true,
                              allowEscapeKey: true
                            },
                            function(isConfirm){
                              if (isConfirm) {
                                $.ajax({
                                    url: 'https://api.backand.com:443/1/objects/ReferOffer/' + parseInt(params),
                                    async: false,
                                    type: 'put',
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                                    },
                                    data: JSON.stringify({
                                        "deletedAt": date
                                    }),
                                    dataType: 'json',
                                    cache: false,
                                    error: function(error){
                                        var errorString = error.responseJSON;
                                        swal({
                                          title: "Error!",
                                          text: errorString,
                                          type: "error",
                                          confirmButtonText: "Close",
                                          allowOutsideClick: true,
                                          allowEscapeKey: true
                                        });
                                    },
                                    success: function(data){
                                        var errorString = "The offer has been deleted"
                                        swal({
                                          title: "Success!",
                                          text: errorString,
                                          type: "success",
                                          confirmButtonText: "Close",
                                          allowOutsideClick: true,
                                          allowEscapeKey: true
                                        });
                                        window.location.replace("/platform/index.html#myoffers")
                                    }
                                });
                              }
                            });
                        });
                        
                    }
                }
                )
                $(".send-message").on("click", function(){
                    var email = "<div style='max-width:600px'><table border='0' cellpadding='0' cellspacing='0' class='body' style='width:100%'><tr style='font-family:sans-serif'><td style='font-size:14px'></td><td class='container' style='font-size:14px'><div class='content'><span class='preheader' style='display:none'>This is preheader text. Some clients will show this text as a preview.</span><table class='main' style='width:100%'><tbody style='background:#fff'><tr style='background-color: #ec9400'><td> <p style='text-align:center'><span style='font-size:30px'><span style='color: white'>ReferralShip</span></span></p></td></tr><tr><td class='wrapper' style='padding:20px'><table border='0' cellpadding='0' cellspacing='0' style='width:100%'><tr><td style='font-size:14px'><p>"+$('#comment').val()+"</p></td></tr></table></td></tr></tbody></table> <div style='height:10px'> </div><div class='footer' style='text-align:center'><table border='0' cellpadding='0' cellspacing='0' style='width:100%'><tr style=''><td class='content-block' style='color:#999999'><span class='apple-link' style='text-align:center'><a href='http://referralship.net' style='color:#999'>Login to your account</a></span><br></td></tr><tr><td class='content-block powered-by' style='font-size:14px'>Powered by <span style='color:#999999'>Referralship</span>.</td></tr></table></div></div></td><td style='font-size:14px'></td></tr></table></div>";
                    var mailData = JSON.stringify({
                      "to": myRecord[0].author,
                      "message": encodeURI(email)
                    });
                    $.ajax({
                        url: 'https://api.backand.com/1/objects/action/ReferOffer/'+parseInt(params)+'?name=SendEmailSendGrid',
                        async: false,
                        type: 'post',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                        },
                        data: mailData,
                        dataType: 'json',
                        cache: false,
                    });
                });
            }
        });
    });
</script>