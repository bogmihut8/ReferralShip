<div class="row">
    <div class="start">
        <div id="offer" class="row">
        </div><br>
        <div class="form-group offer-page-control">
        </div><br>
        
        <div class="interested-message">
            <p>Are you interested in this offer? Get in touch with the author:</p>
    
            <div class="message-form">
                <div class="form-group">
                  <label for="email">Your email:</label>
                  <input type="text" class="form-control span3" id="email">
                </div>
                <div class="form-group">
                  <label for="subject">Subject:</label>
                  <input type="text" class="form-control span3" id="subject">
                </div>
                <div class="form-group">
                  <label for="comment">Message:</label>
                  <textarea class="form-control span6" rows="5" id="comment" placeholder="Your message..."></textarea>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-warning send-message">Send message</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        function ajaxGetCall(url, errorCallback, successCallback){
            $.ajax({
                url: url,
                async: false,
                type: 'get',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                },
                data: {},
                dataType: 'json',
                cache: false,
                error: errorCallback,
                success: successCallback
            });
        }
        
        var currentUser = JSON.parse(localStorage.getItem("currentUser"));
//        var offerId = JSON.parse(localStorage.getItem("activeOfferId"));
        var oKey = JSON.parse(localStorage.getItem("currentKey"))[0].operationKey;
        window.app.page("offer-page", function(){
            return function(params) {
                ajaxGetCall('https://api.backand.com/1/query/data/getReferOffer?parameters=%7B%22id%22:%22'+parseInt(params)+'%22%7D', function(error){alert(JSON.stringify(error))}, 
                function(data){
                    myRecord = data;
                    $("#offer").append("<div class='span12'><p><i class='icon-time'></i>&nbsp;<span class='timeago'>"+$.timeago(myRecord[0].dateCreated)+"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author: "+myRecord[0].author+"</p><h1>"+myRecord[0].title+"</h1><p>"+myRecord[0].content+"</p><h4><b>Company: </b>"+myRecord[0].company+"</h4><h4><b>Location: </b>"+myRecord[0].city+", "+myRecord[0].country+"</h4></div>");
                });
                ajaxGetCall('https://api.backand.com/1/objects/action/ReferOffer/'+parseInt(params)+'?name=allowEdit&parameters=%7B%22operationKey%22:%22'+oKey+'%22%7D',
                function(error){alert(JSON.stringify(error))}, 
                function(data){
                    if(data){
                        $(".offer-page-control").html('<button type="button" class="btn btn-warning">Edit</button>&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-danger">Delete</button>');
                        $(".interested-message").hide();
                    }
                }
                )
                $(".send-message").on("click", function(){
                    $.ajax({
                        url: 'https://api.backand.com/1/objects/action/ReferOffer/'+parseInt(params)+'?name=SendEmailSendGrid&parameters=%7B%22to%22:%22'+myRecord[0].author+'%22,%22message%22:%22'+$("#comment").val()+'%22%7D',
                        async: false,
                        type: 'get',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                        },
                        data: {
                        },
                        dataType: 'json',
                        cache: false,
                    });
                });
            }
        });
    });
</script>