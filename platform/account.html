<img src="img/texture.png" id="background-image">
<div class="row">
    <div class="start account-details row" style="width:100%">
        <h1>Account details</h1>
        <form id="edit-profile" class="form-horizontal">
            <fieldset>

                <div class="control-group">											
                    <label class="control-label" for="email">Email</label>
                    <div class="controls">
                        <input type="text" class="span4 disabled" id="email" disabled>
                        <p class="help-block">Your email is for logging in and cannot be changed.</p>
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->


                <div class="control-group">											
                    <label class="control-label" for="firstname">First Name</label>
                    <div class="controls">
                        <input type="text" class="span4" id="firstname">
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->


                <div class="control-group">											
                    <label class="control-label" for="lastname">Last Name</label>
                    <div class="controls">
                        <input type="text" class="span4" id="lastname">
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->

                <div class="control-group">
                    <button type="button" class="btn btn-warning update-profile">Update profile</button>
                </div>

                <br /><br />

                <div class="control-group">											
                    <label class="control-label" for="password1">Old Password</label>
                    <div class="controls">
                        <input type="password" class="span4" id="password1">
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->


                <div class="control-group">											
                    <label class="control-label" for="password2">New Password</label>
                    <div class="controls">
                        <input type="password" class="span4" id="password2">
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->
                
                <div class="control-group">											
                    <label class="control-label" for="password3">Repeat Password</label>
                    <div class="controls">
                        <input type="password" class="span4" id="password3">
                    </div> <!-- /controls -->				
                </div> <!-- /control-group -->
                <div class="control-group">
                    <button type="button" class="btn btn-warning change-password">Change password</button>
                </div>
            </fieldset>
        </form>
										
    </div>
</div>
<script>
    if(window.location.href.indexOf("index.html#") == -1) {
       window.location.replace('/platform/index.html');
    }
    $(document).ready(function(){
        function ajaxGetCall(url, type, data, errorCallback, successCallback){
            $.ajax({
                url: url,
                async: false,
                type: type,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', currentUser.token_type +' '+ currentUser.access_token);
                },
                data: data,
                dataType: 'json',
                cache: false,
                error: errorCallback,
                success: successCallback
            });
        }
        
        $(".mainnav li").removeClass("active");
        var page = window.location.hash;
        $(".mainnav a[href='"+page+"']").parent().addClass("active");        
        
        var currentUser = JSON.parse(localStorage.getItem("currentUser"));
        var nameObj = JSON.parse(localStorage.getItem("firstAndLastName"));
        $("#email").val(currentUser.username);
        $("#firstname").val(nameObj[0].firstName);
        $("#lastname").val(nameObj[0].lastName);
        var oKey = JSON.parse(localStorage.getItem("currentKey"))[0].operationKey;
       
        $(".update-profile").on("click", function(){
            var firstName = $('#firstname').val();
            var lastName = $('#lastname').val();
            var updateUserData = JSON.stringify({
              "id" : currentUser.userId,
              "firstName": firstName,
              "lastName": lastName,
              "email": currentUser.username,
              "operationKey": oKey
            });
            ajaxGetCall('https://api.backand.com/1/query/data/updateUserDetails', 'post', updateUserData, 
            function(){
                var errorString = error.responseJSON;

                swal({
                  title: "Error!",
                  text: errorString,
                  type: "error",
                  confirmButtonText: "Close",
                  allowOutsideClick: true,
                  allowEscapeKey: true
                });
            }, 
            function(){
                var errorString = "Details were updated"
                swal({
                  title: "Success!",
                  text: errorString,
                  type: "success",
                  confirmButtonText: "Close",
                  allowOutsideClick: true,
                  allowEscapeKey: true
                });
                var newSetter = {};
                newSetter[0] = {
                        'firstName': firstName,
                        'lastName': lastName
                }
                localStorage.setItem("firstAndLastName", JSON.stringify(newSetter));
                var firstAndLastName = JSON.parse(localStorage.getItem("firstAndLastName"));
                $("#nav-username").find("#first").html(firstAndLastName[0].firstName.charAt(0) +""+ firstAndLastName[0].lastName.charAt(0));
                $("#nav-username").find("#second").html(firstName + " " + lastName);
                $('#firstname').val(firstName);
                $('#lastname').val(lastName)
            })
        });
        
        $(".change-password").on("click", function(){
            var changePasswordData = JSON.stringify({
              "oldPassword": $('#password1').val(),
              "newPassword": $('#password2').val()
            });
            if($('#password2').val() === $('#password3').val()){
                ajaxGetCall('https://api.backand.com/1/user/changePassword', 'post', changePasswordData, 
                function(){
                    var errorString = error.responseJSON;

                    swal({
                      title: "Error!",
                      text: errorString,
                      type: "error",
                      confirmButtonText: "Close",
                      allowOutsideClick: true,
                      allowEscapeKey: true
                    });
                }, 
                function(){
                    var errorString = "Password was changed"
                    swal({
                      title: "Success!",
                      text: errorString,
                      type: "success",
                      confirmButtonText: "Close",
                      allowOutsideClick: true,
                      allowEscapeKey: true
                    });
                    $('#password1').val("");$('#password2').val("");$('#password3').val("");
                })
            }
            else{
            var errorString = "Passwords do not match";
            swal({
              title: "Error!",
              text: errorString,
              type: "error",
              confirmButtonText: "Close",
              allowOutsideClick: true,
              allowEscapeKey: true
            });
            }
        });
    });
</script>